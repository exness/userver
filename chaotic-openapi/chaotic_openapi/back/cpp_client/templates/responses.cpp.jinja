#include <client/{{ name }}/responses.hpp>

#include <userver/clients/http/response.hpp>
#include <userver/formats/json/serialize.hpp>
#include <userver/http/common_headers.hpp>
#include <userver/http/content_type.hpp>

{% for include in spec.responses_definitions_includes() %}
  #include <{{ include }}>
{% endfor %}


namespace {{ namespace }} {
{% for op in operations %}
  {% if op.client_generate %}
    namespace {{ op.cpp_namespace() }} {
      Response ParseResponse(USERVER_NAMESPACE::clients::http::Response& http_response)
      {
        switch (static_cast<int>(http_response.status_code())) {
        {% for response in op.responses %}
          case {{ response.status }}:
          {
            Response{{ response.status }} r{};
            {% if response.body %}
                {% if response.is_single_contenttype() %}
                  {# ignore content type for compatibility with poorly written servers #}
                  {% set body = response.single_body() %}
                  auto json = USERVER_NAMESPACE::formats::json::FromString(http_response.body());
                  r.body = json.As<{{ body.parser_type('TODO', 'TODO') }}>();
                {% else %}
                  USERVER_NAMESPACE::http::ContentType content_type = http_response.headers()[USERVER_NAMESPACE::http::headers::kContentType];

                  {% for content_type, body in response.body.items() %}
                      if (content_type == USERVER_NAMESPACE::http::ContentType{"{{ content_type }}"}) {
                        {% if content_type == 'application/json' %}
                          auto json = USERVER_NAMESPACE::formats::json::FromString(http_response.body());
                          r.body = json.As<{{ body.parser_type('TODO', 'TODO') }}>();
                        {% else %}
                            r.body = {{ response.body_cpp_name(content_type) }}{http_response.body()};
                        {% endif %}
                      }
                  {% endfor %}
                {% endif %}
            {% endif %}

            {# TODO: headers #}

            {% if response.is_error() %}
              throw r;
            {% else %}
              return r;
            {% endif %}
          }
        {% endfor %}
        default:
          {# TODO #}
          throw std::runtime_error("unknown status code");
        }
      }
    }
  {% endif %}
{% endfor %}
}
